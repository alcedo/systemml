#!/bin/bash

# error help print
printUsageExit()
{
cat << EOF
Usage: $0 <dml-filename> [arguments] [-help]
    -help     - Print this usage message and exit
EOF
  exit 1
}
#    Script internally invokes 'java -Xmx4g -Xms4g -Xmn400m -jar StandaloneSystemML.jar -f <dml-filename> -exec singlenode -config=SystemML-config.xml [Optional-Arguments]'

while getopts "h:" options; do
  case $options in
    h ) echo Warning: Help requested. Will exit after usage message;
        printUsageExit
        ;;
    \? ) echo Warning: Help requested. Will exit after usage message;
        printUsageExit
        ;;
    * ) echo Error: Unexpected error while processing options;
  esac
done

if [ -z $1 ] ; then
    echo "Wrong Usage.";
    printUsageExit;
fi


# find the systemML root path which contains the bin folder and the system-ml folder
PROJECT_ROOT_PATH=$( cd $(dirname $0)/.. ; pwd -P )

USER_DIR=$PWD

# if the present working directory is the project root, use the temp folder as user.dir
if [[ $USER_DIR = $PROJECT_ROOT_PATH ]]
then
  USER_DIR=${PROJECT_ROOT_PATH}/temp
  echo "user directory: $USER_DIR"
fi


# if the SystemML-config.xml does not exis, create it from the template
if [ ! -f ${PROJECT_ROOT_PATH}/conf/SystemML-config.xml ]
then
  cp ${PROJECT_ROOT_PATH}/conf/SystemML-config.xml.template \
     ${PROJECT_ROOT_PATH}/conf/SystemML-config.xml
  echo "created ${PROJECT_ROOT_PATH}/conf/SystemML-config.xml"
fi

# if the log4j.properties do not exis, create them from the template
if [ ! -f ${PROJECT_ROOT_PATH}/conf/log4j.properties ]
then
  cp ${PROJECT_ROOT_PATH}/conf/log4j.properties.template \
     ${PROJECT_ROOT_PATH}/conf/log4j.properties
  echo "created ${PROJECT_ROOT_PATH}/conf/log4j.properties"
fi


# Peel off first argument so that $@ contains arguments to DML script
SCRIPT_FILE=$1
shift

# if the script file path was omitted, try to complete the script path
if [ ! -f $SCRIPT_FILE ]
then
  SCRIPT_FILE_NAME=$(basename $SCRIPT_FILE)
  SCRIPT_FILE_FOUND=$(find $PROJECT_ROOT_PATH/system-ml/scripts -name $SCRIPT_FILE_NAME)
  if [ ! $SCRIPT_FILE_FOUND ]
  then
    echo "Could not find DML script: $SCRIPT_FILE";
    printUsageExit;
  else
    SCRIPT_FILE=$SCRIPT_FILE_FOUND
    echo "dml script: $SCRIPT_FILE"
  fi
fi


# add hadoop libraries which were generated by the build to the classpath
CLASSPATH=${PROJECT_ROOT_PATH}/system-ml/target/lib/*;

#SYSTEM_ML_JAR=$( find $PROJECT_ROOT_PATH/system-ml/target/system-ml-*-SNAPSHOT.jar )
SYSTEM_ML_JAR=$PROJECT_ROOT_PATH/system-ml/target/classes

CLASSPATH=${CLASSPATH}:${SYSTEM_ML_JAR};


# invoke the jar with options and arguments
java -Xmx8g -Xms4g -Xmn1g -cp ${CLASSPATH} \
     -Duser.dir=${USER_DIR} \
     com.ibm.bi.dml.api.DMLScript \
     -f ${SCRIPT_FILE} -exec singlenode \
     -config=${PROJECT_ROOT_PATH}/conf/SystemML-config.xml \
     $@

